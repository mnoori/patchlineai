# Patchline Multi-Agent System

## System Overview

Patchline uses a multi-agent architecture to provide specialized capabilities for music industry professionals:

- **Gmail Agent**: Handles email operations (search, read, draft, send)
- **Legal Agent**: Analyzes contracts and legal documents
- **Supervisor Agent**: Coordinates between specialists using the agent-as-tools pattern

The system uses AWS Bedrock Agents with Claude foundation models and follows the declarative configuration pattern with `agents.yaml` as the single source of truth.

## Directory Structure

```
patchline_v1/
├── agents.yaml               # Single source of truth for agent configuration
├── prompts/                  # Agent prompts (markdown format)
│   ├── gmail-agent.md
│   ├── legal-agent.md
│   └── supervisor-agent.md
├── lambda/                   # Lambda functions for agent actions
│   ├── gmail-action-handler/
│   └── legal-action-handler/
├── lib/                      # TypeScript library code
│   ├── config.ts
│   ├── models-config.ts
│   ├── supervisor-agent.ts
│   └── generated-agent-ids.ts    # Auto-generated by scripts
└── scripts/
    └── generate-agents.ts    # Agent generation/update script
```

## Adding a New Agent

1. **Update `agents.yaml`**:
   ```yaml
   my-new-agent:
     name: PatchlineNewAgent
     description: Description of what this agent does
     model: claude-3-7-sonnet
     prompt: prompts/new-agent.md
     action_group:
       name: NewAgentActions
       lambda: lambda/new-agent-handler
     knowledge_base: PatchlineNewAgentKnowledge
   ```

2. **Create prompt file**:
   Create a new file at `prompts/new-agent.md` with the agent's instructions.

3. **Create Lambda function**:
   Implement the Lambda function for the agent's actions.

4. **Run the generator script**:
   ```bash
   npm run generate-agents
   ```

5. **Add as collaborator** (if needed):
   Add the new agent to the supervisor's collaborators list:
   ```yaml
   supervisor:
     collaborators: [gmail, legal, my-new-agent]
   ```

## Updating an Agent

### Update Prompt Only

```bash
npm run generate-agents -- --agent gmail --prompt prompts/new-gmail.md
```

### Update Model

Edit `agents.yaml` to change the model, then run:

```bash
npm run generate-agents -- --agent gmail
```

## Advanced Usage

### Checking Configuration

To verify configuration without making changes:

```bash
npm run generate-agents -- --check
```

### Environment Variables

Required environment variables for development:
- `AWS_REGION` (usually us-east-1)
- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`

## Architecture

### Agent-as-Tools Pattern

The Supervisor Agent uses the agent-as-tools pattern to coordinate between specialist agents:

1. The Supervisor exposes Gmail and Legal agents as tools
2. When a user sends a request, the Supervisor:
   - Determines which specialist agents to use
   - Delegates tasks to appropriate agents
   - Combines responses into a unified answer

### Collaboration Workflow

The most common workflow is contract analysis:

1. Supervisor receives query about contracts in email
2. Gmail Agent is called to search and extract contract text
3. Legal Agent analyzes the contract
4. Supervisor presents the combined analysis

## Troubleshooting

### Common Issues

- **Agent not delegating**: Check that agent IDs and alias IDs are correct in `lib/config.ts`.
- **Lambda errors**: Check CloudWatch logs for Lambda function errors.
- **Missing permissions**: Ensure AWS IAM roles have correct permissions.

### Logs

- Agent actions are logged in CloudWatch Logs
- Lambda function logs are in CloudWatch Logs

## Implementation Notes

### Foundation Models

- Gmail Agent: Claude 3.7 Sonnet with inference profile
- Legal Agent: Claude 3.7 Sonnet with inference profile
- Supervisor: Uses direct calls to specialists, no LLM involved

### Limitations

- **API vs Console**: Some Bedrock Agent features (like collaboration) work differently in the console vs API.
- **Prompt Sensitivity**: Agent behavior can be sensitive to prompt changes.
- **Performance**: Complex workflows involving multiple agents can take 10+ seconds to complete.

## Support

For issues or questions, contact the Patchline development team. 