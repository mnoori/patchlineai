# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0
"""
Shows how to generate an image from a text prompt with the Amazon Nova Canvas model (on demand).
"""
import base64
import io
import json
import logging
import boto3
from PIL import Image
from botocore.config import Config

from botocore.exceptions import ClientError


class ImageError(Exception):
    "Custom exception for errors returned by Amazon Nova Canvas"

    def __init__(self, message):
        self.message = message


logger = logging.getLogger(__name__)
logging.basicConfig(level=logging.INFO)


def generate_image(model_id, body):
    """
    Generate an image using Amazon Nova Canvas model on demand.
    Args:
        model_id (str): The model ID to use.
        body (str) : The request body to use.
    Returns:
        image_bytes (bytes): The image generated by the model.
    """

    logger.info(
        "Generating image with Amazon Nova Canvas model %s", model_id)

    bedrock = boto3.client(
        service_name='bedrock-runtime',
        config=Config(read_timeout=300)
    )

    accept = "application/json"
    content_type = "application/json"

    response = bedrock.invoke_model(
        body=body, modelId=model_id, accept=accept, contentType=content_type
    )
    response_body = json.loads(response.get("body").read())

    base64_image = response_body.get("images")[0]
    base64_bytes = base64_image.encode('ascii')
    image_bytes = base64.b64decode(base64_bytes)

    finish_reason = response_body.get("error")

    if finish_reason is not None:
        raise ImageError(f"Image generation error. Error is {finish_reason}")

    logger.info(
        "Successfully generated image with Amazon Nova Canvas model %s", model_id)

    return image_bytes


def main():
    """
    Entrypoint for Amazon Nova Canvas  example.
    """

    logging.basicConfig(level=logging.INFO,
                        format="%(levelname)s: %(message)s")

    model_id = 'amazon.nova-canvas-v1:0'

    prompt = """A photograph of a cup of coffee from the side."""

    body = json.dumps({
        "taskType": "TEXT_IMAGE",
        "textToImageParams": {
            "text": prompt
        },
        "imageGenerationConfig": {
            "numberOfImages": 1,
            "height": 1024,
            "width": 1024,
            "cfgScale": 8.0,
            "seed": 0
        }
    })

    try:
        image_bytes = generate_image(model_id=model_id,
                                     body=body)
        image = Image.open(io.BytesIO(image_bytes))
        image.show()

    except ClientError as err:
        message = err.response["Error"]["Message"]
        logger.error("A client error occurred:", message)
        print("A client error occured: " +
              format(message))
    except ImageError as err:
        logger.error(err.message)
        print(err.message)

    else:
        print(
            f"Finished generating image with Amazon Nova Canvas  model {model_id}.")


if __name__ == "__main__":
    main()

# AWS Nova Canvas Integration Guide

## Overview

This document covers the integration of AWS Nova Canvas with our content creation pipeline, including common issues, fixes, and best practices.

## Table of Contents

1. [Nova Canvas Capabilities](#nova-canvas-capabilities)
2. [Common Errors and Fixes](#common-errors-and-fixes)
3. [Implementation Details](#implementation-details)
4. [Theme System](#theme-system)
5. [Compositing Methods](#compositing-methods)
6. [Code Examples](#code-examples)

## Nova Canvas Capabilities

AWS Nova Canvas supports the following task types:

- **TEXT_IMAGE**: Generate images from text prompts
- **IMAGE_VARIATION**: Create variations of existing images
- **INPAINTING**: Modify specific parts of an image
- **OUTPAINTING**: Extend image boundaries
- **BACKGROUND_REMOVAL**: Remove backgrounds from images
- **COLOR_GUIDED_GENERATION**: Generate images using color palettes
- **CONDITIONING**: Generate images with structural guidance

## Common Errors and Fixes

### Error: "Model produced invalid mask with provided [maskPrompt]"

**Problem**: This error occurs when using an invalid or overly complex `maskPrompt` in inpainting operations.

**Root Cause**: Nova Canvas expects simple object identifiers for `maskPrompt`, not descriptive placement instructions.

**Fix Applied**:
```typescript
// ❌ WRONG - Descriptive placement instruction
maskPrompt: 'the center foreground area, about 40% of the image height from bottom, where the main subject should be placed'

// ✅ CORRECT - Simple object identifier
maskPrompt: 'person' // or 'subject', 'foreground object', etc.
```

**Our Solution**: We've removed the problematic inpainting approach and implemented:
1. Sharp-based server-side compositing for proper image layering
2. IMAGE_VARIATION as a fallback for style transformation
3. Client-side compositing for quick previews

## Implementation Details

### API Route Structure

Our Nova Canvas integration is located at `/api/nova-canvas/generate-with-subject` with the following capabilities:

1. **Background Removal**: Uses Nova Canvas BACKGROUND_REMOVAL task
2. **Background Generation**: Creates themed backgrounds using TEXT_IMAGE
3. **Compositing**: Multiple methods for combining subject and background

### Enhanced Theme System

We've implemented 9 distinct themes with specific prompts:

```typescript
const CONTENT_THEMES = [
  { id: 'vibrant', name: 'Vibrant', description: 'Colorful and energetic' },
  { id: 'cinematic', name: 'Cinematic', description: 'Dramatic and moody' },
  { id: 'minimalist', name: 'Minimalist', description: 'Clean and elegant' },
  { id: 'futuristic', name: 'Futuristic', description: 'Sci-fi and tech-inspired' },
  { id: 'nature', name: 'Nature', description: 'Organic and earthy' },
  { id: 'cyberpunk', name: 'Cyberpunk', description: 'Neon and dystopian' },
  { id: 'vintage', name: 'Vintage', description: 'Retro and nostalgic' },
  { id: 'abstract', name: 'Abstract', description: 'Artistic and conceptual' },
  { id: 'festival', name: 'Festival', description: 'Party and celebration' }
]
```

Each theme has optimized prompts for better generation quality.

## Compositing Methods

### 1. Server-Side Compositing (Sharp)

When Sharp is available, we use it for high-quality server-side compositing:

```typescript
const composite = await sharp(backgroundBuffer)
  .composite([{
    input: subjectResized,
    top: Math.round(bgHeight * 0.3),
    left: Math.round((bgWidth - subjectWidth) / 2),
    blend: 'over'
  }])
  .toBuffer()
```

### 2. Image Variation (Fallback)

If Sharp isn't available, we use Nova Canvas IMAGE_VARIATION:

```typescript
{
  taskType: 'IMAGE_VARIATION',
  imageVariationParams: {
    text: stylePrompt,
    images: [backgroundImage],
    similarityStrength: 0.3  // Low similarity for creative freedom
  }
}
```

### 3. Client-Side Compositing

For quick previews, we use Canvas API in the browser:

```typescript
const compositeBase64 = await compositeImagesClient(
  backgroundBase64,
  transparentSubject,
  { position: { x: 0.5, y: 0.5 }, scale: 0.8 }
)
```

## Code Examples

### Text to Image Generation

```python
import boto3
import json
import base64

client = boto3.client('bedrock-runtime')

body = json.dumps({
    "taskType": "TEXT_IMAGE",
    "textToImageParams": {
        "text": "A robot playing soccer, anime cartoon style",
        "negativeText": "bad quality, low res"
    },
    "imageGenerationConfig": {
        "numberOfImages": 1,
        "height": 512,
        "width": 512,
        "cfgScale": 8.0
    }
})

response = client.invoke_model(
    modelId='amazon.nova-canvas-v1:0',
    body=body
)
```

### Inpainting (Correct Usage)

```python
body = json.dumps({
    "taskType": "INPAINTING",
    "inPaintingParams": {
        "text": "Modernize the windows of the house",
        "negativeText": "bad quality, low res",
        "image": input_image,
        "maskPrompt": "windows"  # Simple object identifier
    },
    "imageGenerationConfig": {
        "numberOfImages": 1,
        "height": 512,
        "width": 512,
        "cfgScale": 8.0
    }
})
```

### Outpainting

```python
body = json.dumps({
    "taskType": "OUTPAINTING",
    "outPaintingParams": {
        "text": "Draw a chocolate chip cookie",
        "negativeText": "bad quality, low res",
        "image": input_image,
        "maskImage": input_mask_image,
        "outPaintingMode": "DEFAULT"
    },
    "imageGenerationConfig": {
        "numberOfImages": 1,
        "height": 512,
        "width": 512,
        "cfgScale": 8.0
    }
})
```

### Image Variation

```python
body = json.dumps({
    "taskType": "IMAGE_VARIATION",
    "imageVariationParams": {
        "text": "Modernize the house, photo-realistic, 8k, hdr",
        "negativeText": "bad quality, low resolution, cartoon",
        "images": [input_image],
        "similarityStrength": 0.7,  # Range: 0.2 to 1.0
    },
    "imageGenerationConfig": {
        "numberOfImages": 1,
        "height": 512,
        "width": 512,
        "cfgScale": 8.0
    }
})
```

### Conditioning

```python
body = json.dumps({
    "taskType": "TEXT_IMAGE",
    "textToImageParams": {
        "text": "A robot playing soccer, anime cartoon style",
        "negativeText": "bad quality, low res",
        "conditionImage": input_image,
        "controlMode": "CANNY_EDGE"
    },
    "imageGenerationConfig": {
        "numberOfImages": 1,
        "height": 512,
        "width": 512,
        "cfgScale": 8.0
    }
})
```

### Color-Guided Generation

```python
body = json.dumps({
    "taskType": "COLOR_GUIDED_GENERATION",
    "colorGuidedGenerationParams": {
        "text": "digital painting of a girl, dreamy and ethereal",
        "negativeText": "bad quality, low res",
        "referenceImage": input_image,
        "colors": ["#ff8080", "#ffb280", "#ffe680", "#ffe680"]
    },
    "imageGenerationConfig": {
        "numberOfImages": 1,
        "height": 512,
        "width": 512,
        "cfgScale": 8.0
    }
})
```

## Best Practices

1. **Always validate base64 images** before sending to Nova Canvas
2. **Use appropriate task types** - Don't try to composite images with inpainting
3. **Keep prompts specific** but avoid overly complex descriptions
4. **Use negative prompts** to improve quality
5. **Implement fallbacks** for when specific methods fail
6. **Cache generated backgrounds** to reduce API calls

## Troubleshooting

### Image Size Limits
- Maximum input size: 5MB
- Recommended dimensions: 1024x1024 for best results
- Always resize images before processing

### Rate Limits
- Implement exponential backoff for retries
- Cache results when possible
- Use batch processing for multiple images

### Quality Issues
- Increase `cfgScale` for better prompt adherence (7.0-10.0)
- Use specific negative prompts
- Experiment with different seed values

## Environment Variables

Required environment variables:

```bash
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
ENABLE_NOVA_CANVAS=true
S3_IMAGE_BUCKET=patchline-files-us-east-1
```

## Future Enhancements

1. **Batch Processing**: Process multiple images in parallel
2. **Style Transfer**: Use conditioning for more advanced style transfer
3. **Smart Cropping**: Automatically detect and crop to subject
4. **A/B Testing**: Test different prompts and settings automatically
5. **Analytics**: Track which themes and styles perform best